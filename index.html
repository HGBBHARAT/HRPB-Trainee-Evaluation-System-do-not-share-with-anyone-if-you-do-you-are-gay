<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRPB Trainee Evaluation for Staff Team</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'slate': {
                            700: '#334155', // Customizing the palette used in the JSX
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        // Custom colors for better visual feedback (optional)
                        'hrp-green': '#10b981', // emerald-500
                        'hrp-red': '#ef4444', // red-500
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background-color: #0f172a; /* slate-900 */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- CRITICAL: API CONFIGURATION ---
        const API_ENDPOINT = "http://s9.katabump.com:5000"; 
        // Note: Ensure this matches the host/port where your Python bot is running.

        // --- MOCKED LUCIDE ICON COMPONENTS (FIXED & COMPLETE) ---
        // These replace the actual lucide-react imports for single-file HTML use.
        const User = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Loader2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite" /></svg>;
        const List = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>;
        const XCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>;
        const Plus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const Save = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8h3.5L12 3.5 3.5 13H7v8"/></svg>;
        const Check = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>;
        const Mic = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></svg>;
        const Volume2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>;
        const AlertTriangle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>;
        const CornerDownLeft = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 10 10 15 15 20"/><path d="M21 15H10a4 4 0 0 1-4-4V4"/></svg>;


        // --- UTILITY COMPONENTS ---

        // Tab Button Component
        const TabButton = ({ icon: Icon, label, isActive, onClick }) => {
            const activeClasses = 'bg-slate-700 text-purple-400 border-purple-500';
            const inactiveClasses = 'hover:bg-slate-700 text-gray-300 border-transparent';

            return (
                <button
                    className={`flex items-center space-x-2 px-4 py-2 border-l-4 transition-colors duration-150 ${isActive ? activeClasses : inactiveClasses}`}
                    onClick={onClick}
                >
                    <Icon size={18} /> 
                    <span className="font-medium">{label}</span>
                </button>
            );
        };

        // Trainee Input Component
        const TraineeInput = ({ index, trainee, updateTrainee, removeTrainee }) => {
            const handleStatusChange = (e) => {
                const status = e.target.value;
                let newState = { status };
                
                // Reset assessment fields if status is not PASSED/FAILED
                if (status === 'PASSED' || status === 'FAILED') {
                    if (!trainee.assessment) newState.assessment = { moderation: {}, weaponHandling: {} };
                } else {
                    newState.assessment = null;
                }

                // Clear disqualification if status is not DISQUALIFIED
                if (status !== 'DISQUALIFIED') {
                    newState.disqualification = null;
                } else {
                    if (!trainee.disqualification) newState.disqualification = { reason: '', proofLink: '' };
                }

                updateTrainee(index, newState);
            };

            const handleDisqualificationChange = (field, value) => {
                updateTrainee(index, {
                    disqualification: { ...trainee.disqualification, [field]: value }
                });
            };

            const handleAssessmentChange = (section, field, value) => {
                updateTrainee(index, {
                    assessment: { 
                        ...trainee.assessment, 
                        [section]: {
                            ...trainee.assessment?.[section],
                            [field]: value
                        }
                    }
                });
            };

            return (
                <div className="p-4 border border-slate-700 rounded-lg bg-slate-800 space-y-4 shadow-lg">
                    <div className="flex justify-between items-start border-b border-slate-700 pb-2">
                        <h4 className="text-lg font-semibold text-gray-200">Trainee #{index + 1}</h4>
                        <button
                            type="button"
                            onClick={() => removeTrainee(index)}
                            className="text-hrp-red hover:text-red-400 transition duration-150"
                            title="Remove Trainee"
                        >
                            <XCircle size={20} />
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <InputField 
                            label="Discord ID" 
                            placeholder="123456789012345678" 
                            value={trainee.traineeDiscordId || ''} 
                            onChange={(e) => updateTrainee(index, { traineeDiscordId: e.target.value })}
                            required
                        />
                        <InputField 
                            label="Roblox Username" 
                            placeholder="PlayerName" 
                            value={trainee.traineeRobloxUsername || ''} 
                            onChange={(e) => updateTrainee(index, { traineeRobloxUsername: e.target.value })}
                            required
                        />
                    </div>

                    <SelectField
                        label="Final Status"
                        value={trainee.status || 'PENDING'}
                        onChange={handleStatusChange}
                        options={[
                            { value: 'PASSED', label: 'âœ… PASSED' },
                            { value: 'FAILED', label: 'âŒ FAILED' },
                            { value: 'DISQUALIFIED', label: 'ðŸš¨ DISQUALIFIED' },
                            { value: 'PENDING', label: 'â³ PENDING' }
                        ]}
                    />

                    {/* --- DISQUALIFICATION SECTION --- */}
                    {trainee.status === 'DISQUALIFIED' && (
                        <div className="p-4 bg-red-900/30 border border-red-700 rounded-md space-y-3">
                            <h5 className="text-md font-bold text-red-300">Disqualification Details</h5>
                            <SelectField
                                label="Reason"
                                value={trainee.disqualification?.reason || ''}
                                onChange={(e) => handleDisqualificationChange('reason', e.target.value)}
                                options={[
                                    { value: '', label: 'Select Reason...' },
                                    { value: 'Inappropriate Language', label: 'Inappropriate Language' },
                                    { value: 'Exploiting', label: 'Exploiting' },
                                    { value: 'Toxic Behavior', label: 'Toxic Behavior' },
                                    { value: 'Ignoring Orders', label: 'Ignoring Orders' },
                                    { value: 'Other', label: 'Other' }
                                ]}
                                required
                            />
                            <InputField
                                label="Proof Link"
                                placeholder="Link to video/screenshot proof"
                                value={trainee.disqualification?.proofLink || ''}
                                onChange={(e) => handleDisqualificationChange('proofLink', e.target.value)}
                                required
                            />
                        </div>
                    )}

                    {/* --- ASSESSMENT SECTION (PASSED/FAILED) --- */}
                    {(trainee.status === 'PASSED' || trainee.status === 'FAILED') && (
                        <div className="p-4 bg-slate-900 border border-slate-700 rounded-md space-y-4">
                            <h5 className="text-md font-bold text-gray-300">Assessment & Scores</h5>
                            
                            {/* Knowledge Score */}
                            <InputField 
                                label="Knowledge Score (0-10)" 
                                type="number" 
                                min="0" 
                                max="10"
                                placeholder="e.g., 9" 
                                value={trainee.knowledgeScore || ''} 
                                onChange={(e) => updateTrainee(index, { knowledgeScore: parseInt(e.target.value) || '' })}
                                required
                            />

                            {/* Moderation Checkboxes */}
                            <h6 className="text-sm font-semibold text-gray-400 mt-4">Moderation Skills</h6>
                            <div className="grid grid-cols-2 gap-3">
                                <CheckboxField 
                                    label="Good English Used" 
                                    checked={trainee.assessment?.moderation?.goodEnglish || false} 
                                    onChange={(e) => handleAssessmentChange('moderation', 'goodEnglish', e.target.checked)}
                                />
                                <CheckboxField 
                                    label="Asked for Proof" 
                                    checked={trainee.assessment?.moderation?.askedForProof || false} 
                                    onChange={(e) => handleAssessmentChange('moderation', 'askedForProof', e.target.checked)}
                                />
                                <CheckboxField 
                                    label="Healed Trainer/Self" 
                                    checked={trainee.assessment?.moderation?.healedTrainer || false} 
                                    onChange={(e) => handleAssessmentChange('moderation', 'healedTrainer', e.target.checked)}
                                />
                                <CheckboxField 
                                    label="Punished Correctly" 
                                    checked={trainee.assessment?.moderation?.punishedCorrectly || false} 
                                    onChange={(e) => handleAssessmentChange('moderation', 'punishedCorrectly', e.target.checked)}
                                />
                            </div>

                            {/* Weapon Handling */}
                            <h6 className="text-sm font-semibold text-gray-400 mt-4">Weapon Handling</h6>
                            <div className="grid grid-cols-2 gap-3">
                                <InputField 
                                    label="Deaths" 
                                    type="number" 
                                    min="0"
                                    placeholder="e.g., 2" 
                                    value={trainee.assessment?.weaponHandling?.deaths || 0} 
                                    onChange={(e) => handleAssessmentChange('weaponHandling', 'deaths', parseInt(e.target.value) || 0)}
                                    required
                                />
                                <CheckboxField 
                                    label="Killed Sniper" 
                                    checked={trainee.assessment?.weaponHandling?.killedSniper || false} 
                                    onChange={(e) => handleAssessmentChange('weaponHandling', 'killedSniper', e.target.checked)}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Generic Input Field
        const InputField = ({ label, type = 'text', ...props }) => (
            <div className="flex flex-col space-y-1">
                <label className="text-sm font-medium text-gray-300">{label}</label>
                <input
                    type={type}
                    className="w-full px-3 py-2 text-sm text-white bg-slate-700 border border-slate-600 rounded-md focus:ring-purple-500 focus:border-purple-500 transition duration-150"
                    {...props}
                />
            </div>
        );

        // Generic Select Field
        const SelectField = ({ label, options, ...props }) => (
            <div className="flex flex-col space-y-1">
                <label className="text-sm font-medium text-gray-300">{label}</label>
                <select
                    className="w-full px-3 py-2 text-sm text-white bg-slate-700 border border-slate-600 rounded-md focus:ring-purple-500 focus:border-purple-500 transition duration-150 appearance-none"
                    {...props}
                >
                    {options.map(option => (
                        <option key={option.value} value={option.value}>{option.label}</option>
                    ))}
                </select>
            </div>
        );

        // Generic Checkbox Field
        const CheckboxField = ({ label, ...props }) => (
            <div className="flex items-center space-x-2">
                <input
                    type="checkbox"
                    className="w-4 h-4 text-purple-600 bg-slate-700 border-slate-600 rounded focus:ring-purple-500"
                    {...props}
                />
                <label className="text-sm text-gray-400 select-none">{label}</label>
            </div>
        );

        // --- MAIN FORM COMPONENTS ---

        // Evaluation Form Component
        const EvaluationForm = ({ db, userId }) => {
            const initialTrainee = {
                traineeDiscordId: '',
                traineeRobloxUsername: '',
                status: 'PENDING',
                knowledgeScore: '',
                assessment: { moderation: {}, weaponHandling: {} },
                disqualification: null 
            };
            const [trainerRobloxUsername, setTrainerRobloxUsername] = useState('');
            const [coTrainers, setCoTrainers] = useState(['']); // Only one co-trainer for simplicity
            const [trainees, setTrainees] = useState([initialTrainee]);
            const [submissionStatus, setSubmissionStatus] = useState(null); // null, 'loading', 'success', 'error'
            const [error, setError] = useState(null);

            const addTrainee = () => setTrainees([...trainees, initialTrainee]);
            
            const updateTrainee = (index, newValues) => {
                const newTrainees = [...trainees];
                newTrainees[index] = { ...newTrainees[index], ...newValues };
                setTrainees(newTrainees);
            };

            const removeTrainee = (index) => {
                const newTrainees = trainees.filter((_, i) => i !== index);
                setTrainees(newTrainees.length > 0 ? newTrainees : [initialTrainee]);
            };

            const validateForm = () => {
                if (!trainerRobloxUsername.trim()) {
                    return "Trainer Roblox Username is required.";
                }
                if (trainees.length === 0) {
                    return "At least one trainee must be added.";
                }

                for (const trainee of trainees) {
                    if (!trainee.traineeDiscordId || !trainee.traineeRobloxUsername) {
                        return "All trainees must have Discord ID and Roblox Username.";
                    }
                    if (trainee.status === 'DISQUALIFIED') {
                        if (!trainee.disqualification?.reason || !trainee.disqualification?.proofLink) {
                            return `Disqualification details are required for ${trainee.traineeRobloxUsername}.`;
                        }
                    } else if (trainee.status === 'PASSED' || trainee.status === 'FAILED') {
                        if (trainee.knowledgeScore === '' || trainee.knowledgeScore < 0 || trainee.knowledgeScore > 10) {
                            return `Knowledge Score (0-10) is required for ${trainee.traineeRobloxUsername}.`;
                        }
                    } else if (trainee.status === 'PENDING') {
                         return `Final status must be selected for all trainees.`;
                    }
                }
                return null; // No errors
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const validationError = validateForm();
                if (validationError) {
                    setError(validationError);
                    setSubmissionStatus('error');
                    setTimeout(() => setError(null), 5000);
                    return;
                }

                const payload = {
                    trainerRobloxUsername,
                    coTrainers: coTrainers.filter(name => name.trim() !== ''),
                    timestamp: new Date().toISOString(),
                    trainees: trainees.map(t => ({
                        traineeDiscordId: t.traineeDiscordId,
                        traineeRobloxUsername: t.traineeRobloxUsername,
                        status: t.status,
                        knowledgeScore: t.knowledgeScore,
                        assessment: (t.status === 'PASSED' || t.status === 'FAILED') ? t.assessment : null,
                        disqualification: t.status === 'DISQUALIFIED' ? t.disqualification : null
                    }))
                };

                setSubmissionStatus('loading');
                setError(null);

                try {
                    const response = await fetch(`${API_ENDPOINT}/submit-evaluation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        setSubmissionStatus('success');
                        // Reset form fields
                        setTrainerRobloxUsername('');
                        setCoTrainers(['']);
                        setTrainees([initialTrainee]);
                    } else {
                        console.error('API Post Failed:', response.status);
                        const errorData = await response.json().catch(() => ({ error: 'No details from server.' }));
                        setSubmissionStatus('error');
                        setError(`Submission failed (HTTP ${response.status}). Bot error: ${errorData.error || 'Check console.'}`);
                    }
                } catch (err) {
                    console.error('Network Error:', err);
                    setSubmissionStatus('error');
                    setError('Could not connect to the bot server. Check if the bot is running and the port is open.');
                } finally {
                    setTimeout(() => setSubmissionStatus(null), 3000);
                    setTimeout(() => setError(null), 5000);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="p-4 bg-slate-800 rounded-lg shadow-xl space-y-4">
                        <h3 className="text-xl font-bold text-gray-100 border-b border-slate-700 pb-2">Trainer Details</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <InputField 
                                label="Trainer Roblox Username" 
                                placeholder="YourUsername" 
                                value={trainerRobloxUsername} 
                                onChange={(e) => setTrainerRobloxUsername(e.target.value)}
                                required
                            />
                            <InputField 
                                label="Co-Trainer Roblox Username (Optional)" 
                                placeholder="CoTrainerUsername" 
                                value={coTrainers[0]} 
                                onChange={(e) => setCoTrainers([e.target.value])}
                            />
                        </div>
                    </div>

                    <div className="p-4 bg-slate-800 rounded-lg shadow-xl space-y-4">
                        <h3 className="text-xl font-bold text-gray-100 border-b border-slate-700 pb-2 flex justify-between items-center">
                            Trainee Results
                            <button 
                                type="button" 
                                onClick={addTrainee} 
                                className="text-purple-400 hover:text-purple-300 transition duration-150 flex items-center space-x-1 text-sm font-normal"
                            >
                                <Plus size={16} />
                                <span>Add Trainee</span>
                            </button>
                        </h3>

                        <div className="space-y-6">
                            {trainees.map((trainee, index) => (
                                <TraineeInput
                                    key={index}
                                    index={index}
                                    trainee={trainee}
                                    updateTrainee={updateTrainee}
                                    removeTrainee={removeTrainee}
                                />
                            ))}
                        </div>
                    </div>

                    {error && (
                        <div className="p-3 text-sm text-red-400 bg-red-900/30 rounded-lg flex items-center">
                            <AlertTriangle size={18} className="mr-2" />
                            {error}
                        </div>
                    )}

                    <button
                        type="submit"
                        disabled={submissionStatus === 'loading'}
                        className={`w-full px-4 py-3 text-lg font-bold text-white rounded-lg transition-colors duration-200 flex items-center justify-center ${
                            submissionStatus === 'success' ? 'bg-green-600/90' :
                            submissionStatus === 'error' ? 'bg-red-600/90' :
                            submissionStatus === 'loading' ? 'bg-slate-700 cursor-not-allowed' :
                            'bg-purple-600 hover:bg-purple-700'
                        }`}
                    >
                        {submissionStatus === 'loading' ? (
                            <><Loader2 size={20} className="mr-3 animate-spin" /> Submitting Evaluation...</>
                        ) : submissionStatus === 'success' ? (
                            <><Check size={20} className="mr-3" /> Submitted Successfully!</>
                        ) : submissionStatus === 'error' ? (
                            <><AlertTriangle size={20} className="mr-3" /> Submission Failed</>
                        ) : (
                            <><CornerDownLeft size={20} className="mr-3" /> **Submit Results to Discord**</>
                        )}
                    </button>
                </form>
            );
        };

        // Voice Verification Component
        const VoiceVerificationTab = ({ db, userId }) => {
            const initialTrainee = {
                traineeDiscordId: '',
                traineeRobloxUsername: '',
                ageRange: '13-16' 
            };
            const [trainees, setTrainees] = useState([initialTrainee]);
            const [submissionStatus, setSubmissionStatus] = useState(null);
            const [error, setError] = useState(null);

            const addTrainee = () => setTrainees([...trainees, initialTrainee]);
            
            const updateTrainee = (index, newValues) => {
                const newTrainees = [...trainees];
                newTrainees[index] = { ...newTrainees[index], ...newValues };
                setTrainees(newTrainees);
            };

            const removeTrainee = (index) => {
                const newTrainees = trainees.filter((_, i) => i !== index);
                setTrainees(newTrainees.length > 0 ? newTrainees : [initialTrainee]);
            };

            const validateForm = () => {
                if (trainees.length === 0) return "At least one trainee must be added.";
                for (const trainee of trainees) {
                    if (!trainee.traineeDiscordId || !trainee.traineeRobloxUsername) {
                        return "All trainees must have Discord ID and Roblox Username.";
                    }
                }
                return null;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const validationError = validateForm();
                if (validationError) {
                    setError(validationError);
                    setSubmissionStatus('error');
                    setTimeout(() => setError(null), 5000);
                    return;
                }

                const payload = {
                    date: new Date().toISOString(),
                    trainees: trainees
                };

                setSubmissionStatus('loading');
                setError(null);

                try {
                    const response = await fetch(`${API_ENDPOINT}/submit-voice-verification`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        setSubmissionStatus('success');
                        setTrainees([initialTrainee]); // Reset form
                    } else {
                        console.error('API Post Failed:', response.status);
                        const errorData = await response.json().catch(() => ({ error: 'No details from server.' }));
                        setSubmissionStatus('error');
                        setError(`Submission failed (HTTP ${response.status}). Bot error: ${errorData.error || 'Check console.'}`);
                    }
                } catch (err) {
                    console.error('Network Error:', err);
                    setSubmissionStatus('error');
                    setError('Could not connect to the bot server.');
                } finally {
                    setTimeout(() => setSubmissionStatus(null), 3000);
                    setTimeout(() => setError(null), 5000);
                }
            };

            const TraineeVoiceInput = ({ index, trainee, updateTrainee, removeTrainee }) => (
                <div className="p-4 border border-slate-700 rounded-lg bg-slate-800 space-y-4 shadow-lg">
                    <div className="flex justify-between items-start border-b border-slate-700 pb-2">
                        <h4 className="text-lg font-semibold text-gray-200">Verified Trainee #{index + 1}</h4>
                        <button
                            type="button"
                            onClick={() => removeTrainee(index)}
                            className="text-hrp-red hover:text-red-400 transition duration-150"
                            title="Remove Trainee"
                        >
                            <XCircle size={20} />
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <InputField 
                            label="Discord ID" 
                            placeholder="123456789012345678" 
                            value={trainee.traineeDiscordId || ''} 
                            onChange={(e) => updateTrainee(index, { traineeDiscordId: e.target.value })}
                            required
                        />
                        <InputField 
                            label="Roblox Username" 
                            placeholder="PlayerName" 
                            value={trainee.traineeRobloxUsername || ''} 
                            onChange={(e) => updateTrainee(index, { traineeRobloxUsername: e.target.value })}
                            required
                        />
                        <SelectField
                            label="Age Range (Perception)"
                            value={trainee.ageRange || '13-16'}
                            onChange={(e) => updateTrainee(index, { ageRange: e.target.value })}
                            options={[
                                { value: '13-16', label: '13-16' },
                                { value: '17-20', label: '17-20' },
                                { value: '21+', label: '21+' }
                            ]}
                        />
                    </div>
                </div>
            );

            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="p-4 bg-slate-800 rounded-lg shadow-xl space-y-4">
                        <h3 className="text-xl font-bold text-gray-100 border-b border-slate-700 pb-2 flex justify-between items-center">
                            Voice Verification List
                            <button 
                                type="button" 
                                onClick={addTrainee} 
                                className="text-teal-400 hover:text-teal-300 transition duration-150 flex items-center space-x-1 text-sm font-normal"
                            >
                                <Plus size={16} />
                                <span>Add Trainee</span>
                            </button>
                        </h3>

                        <div className="space-y-6">
                            {trainees.map((trainee, index) => (
                                <TraineeVoiceInput
                                    key={index}
                                    index={index}
                                    trainee={trainee}
                                    updateTrainee={updateTrainee}
                                    removeTrainee={removeTrainee}
                                />
                            ))}
                        </div>
                    </div>

                    {error && (
                        <div className="p-3 text-sm text-red-400 bg-red-900/30 rounded-lg flex items-center">
                            <AlertTriangle size={18} className="mr-2" />
                            {error}
                        </div>
                    )}

                    <button
                        type="submit"
                        disabled={submissionStatus === 'loading'}
                        className={`w-full px-4 py-3 text-lg font-bold text-white rounded-lg transition-colors duration-200 flex items-center justify-center ${
                            submissionStatus === 'success' ? 'bg-green-600/90' :
                            submissionStatus === 'error' ? 'bg-red-600/90' :
                            submissionStatus === 'loading' ? 'bg-slate-700 cursor-not-allowed' :
                            'bg-teal-600 hover:bg-teal-700'
                        }`}
                    >
                        {submissionStatus === 'loading' ? (
                            <><Loader2 size={20} className="mr-3 animate-spin" /> Submitting Verification...</>
                        ) : submissionStatus === 'success' ? (
                            <><Check size={20} className="mr-3" /> Verification Sent Successfully!</>
                        ) : submissionStatus === 'error' ? (
                            <><AlertTriangle size={20} className="mr-3" /> Submission Failed</>
                        ) : (
                            <><Mic size={20} className="mr-3" /> **Submit Verification to Discord**</>
                        )}
                    </button>
                </form>
            );
        };

        // Announcement Tab Component
        const AnnounceTrainingTab = ({ db, userId }) => {
             const [announcementText, setAnnouncementText] = useState('');
             const [copyStatus, setCopyStatus] = useState(null); // null, 'success', 'error', 'loading'
             const [error, setError] = useState(null);
             
             const handleAnnounce = async () => {
                 setCopyStatus('loading');
                 setError(null);
                 
                 if (!announcementText.trim()) {
                     setCopyStatus('error');
                     setError('Announcement text cannot be empty.');
                     setTimeout(() => setCopyStatus(null), 3000);
                     setTimeout(() => setError(null), 5000);
                     return;
                 }

                 try {
                    const response = await fetch(`${API_ENDPOINT}/submit-announcement`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ announcementText: announcementText }),
                    });

                    if (response.ok) {
                        setCopyStatus('success');
                        setAnnouncementText(''); // Clear on success
                    } else {
                        console.error('API Post Failed:', response.status);
                        const errorData = await response.json().catch(() => ({ error: 'No details from server.' }));
                        setCopyStatus('error');
                        setError(`Announcement failed (HTTP ${response.status}). Bot error: ${errorData.error || 'Check console.'}`);
                    }
                } catch (err) {
                    console.error('Network Error:', err);
                    setCopyStatus('error');
                    setError('Could not connect to the bot server for announcements. Check console for details.');
                } finally {
                    setTimeout(() => setCopyStatus(null), 3000);
                    setTimeout(() => setError(null), 5000);
                }
             };
             
             return (
                <div className="space-y-6 p-4 bg-slate-800 rounded-lg">
                    <h3 className="text-xl font-bold text-gray-100 border-b border-slate-700 pb-2">Training Announcement</h3>
                    
                    {error && (
                        <div className="p-3 text-sm text-red-400 bg-red-900/30 rounded-lg flex items-center">
                            <AlertTriangle size={18} className="mr-2" />
                            {error}
                        </div>
                    )}
                    
                    <div className="flex flex-col space-y-1">
                        <label className="text-sm font-medium text-gray-300">Announcement Details</label>
                        <textarea
                            value={announcementText}
                            onChange={(e) => setAnnouncementText(e.target.value)}
                            placeholder="e.g., Training starting in 5 minutes! Join VC 1."
                            rows="4"
                            className="w-full px-3 py-2 text-sm text-white bg-slate-700 border border-slate-600 rounded-md focus:ring-purple-500 focus:border-purple-500 transition duration-150"
                        />
                    </div>
                    
                    <button
                        onClick={handleAnnounce}
                        disabled={copyStatus === 'loading'}
                        className={`w-full px-4 py-3 text-lg font-bold text-white rounded-lg transition-colors duration-200 flex items-center justify-center ${
                            copyStatus === 'success' ? 'bg-green-600/90' :
                            copyStatus === 'error' ? 'bg-red-600/90' :
                            copyStatus === 'loading' ? 'bg-slate-700 cursor-not-allowed' :
                            'bg-purple-600 hover:bg-purple-700'
                        }`}
                    >
                        {copyStatus === 'loading' ? (
                            <><Loader2 size={20} className="mr-3 animate-spin" /> Sending Announcement...</>
                        ) : copyStatus === 'success' ? (
                            <><Check size={20} className="mr-3" /> Sent Successfully!</>
                        ) : copyStatus === 'error' ? (
                            <><AlertTriangle size={20} className="mr-3" /> Send Failed</>
                        ) : (
                            <><Volume2 size={20} className="mr-3" /> **Announce to Discord Channel**</>
                        )}
                    </button>
                </div>
             );
        };

        // --- MAIN APP COMPONENT ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('announcement');
            const userId = "DefaultUser123"; // This would typically be determined by login/db
            const db = {}; // Placeholder for any database functions

            return (
                <div className="min-h-screen p-4 sm:p-8 flex justify-center items-start">
                    <div className="w-full max-w-4xl bg-slate-900 p-6 sm:p-8 rounded-xl shadow-2xl space-y-8">
                        <header className="border-b border-slate-700 pb-4">
                            <h1 className="text-3xl font-extrabold text-white">HRPB Training Dashboard</h1>
                            <p className="text-gray-400 mt-1">Submit evaluations, voice verifications, and announcements.</p>
                        </header>

                        <div className="flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-8">
                            {/* Tab Navigation */}
                            <div className="flex flex-col space-y-2 w-full lg:w-64 border-r border-slate-700 pr-4">
                                <TabButton
                                    icon={Volume2}
                                    label="Make Announcement"
                                    isActive={activeTab === 'announcement'}
                                    onClick={() => setActiveTab('announcement')}
                                />
                                <TabButton
                                    icon={List}
                                    label="Submit Results"
                                    isActive={activeTab === 'results'}
                                    onClick={() => setActiveTab('results')}
                                />
                                <TabButton
                                    icon={Mic}
                                    label="Voice Verification"
                                    isActive={activeTab === 'voice'}
                                    onClick={() => setActiveTab('voice')}
                                />
                            </div>

                            {/* Conditional Content Rendering */}
                            <div className="flex-grow">
                                {activeTab === 'results' && (
                                    <EvaluationForm db={db} userId={userId} />
                                )}

                                {activeTab === 'announcement' && (
                                    <AnnounceTrainingTab db={db} userId={userId} />
                                )}

                                {activeTab === 'voice' && (
                                    <VoiceVerificationTab db={db} userId={userId} />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the App component to the root element
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    </script>

</body>
</html>
