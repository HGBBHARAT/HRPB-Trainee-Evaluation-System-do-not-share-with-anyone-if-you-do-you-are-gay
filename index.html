<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRPB Trainee Evaluation for Staff Team</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'slate': {
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        'hrp-green': '#10b981', // Emerald 500
                        'hrp-red': '#ef4444',   // Red 500
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Basic styling for the dark background */
        body {
            background-color: #0f172a; /* slate-900 */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Custom scrollbar for better dark mode look */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155; /* slate-700 */
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #475569; /* slate-600 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ====================================================================
        // ICON COMPONENTS (Lucide)
        // ====================================================================

        const createIconComponent = (iconName, size = 20) => {
            return (props) => {
                const iconElement = React.useMemo(() => {
                    const iconFn = lucide.icons[iconName];
                    if (!iconFn) return null;
                    return iconFn({ width: size, height: size, ...props });
                }, [props]);
                return iconElement;
            };
        };

        const List = createIconComponent('List');
        const Volume2 = createIconComponent('Volume2');
        const Mic = createIconComponent('Mic');
        const ClipboardCheck = createIconComponent('ClipboardCheck');
        const ClipboardCopy = createIconComponent('ClipboardCopy');
        const X = createIconComponent('X');
        const Check = createIconComponent('Check');
        const Loader2 = createIconComponent('Loader2');
        const AlertTriangle = createIconComponent('AlertTriangle');
        const Plus = createIconComponent('Plus');
        const Trash2 = createIconComponent('Trash2');


        // ====================================================================
        // UTILITY COMPONENTS
        // ====================================================================

        const InputGroup = ({ label, value, onChange, placeholder = "", type = "text", required = false, step = null, min = null, max = null }) => (
            <div className="flex flex-col space-y-1">
                <label className="text-sm font-medium text-gray-300">{label}{required && <span className="text-hrp-red">*</span>}</label>
                <input
                    type={type}
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    placeholder={placeholder}
                    required={required}
                    step={step}
                    min={min}
                    max={max}
                    className="w-full px-3 py-2 text-sm text-white bg-slate-800 border border-slate-700 rounded-md focus:ring-hrp-green focus:border-hrp-green transition duration-150"
                />
            </div>
        );
        
        const CheckboxGroup = ({ label, checked, onChange }) => (
            <div className="flex items-center space-x-2">
                <input
                    type="checkbox"
                    checked={checked}
                    onChange={(e) => onChange(e.target.checked)}
                    className="w-4 h-4 text-hrp-green bg-slate-800 border-slate-700 rounded focus:ring-hrp-green"
                />
                <label className="text-sm font-medium text-gray-300">{label}</label>
            </div>
        );

        const RoleInput = ({ value, onChange, placeholder = "Roblox Username" }) => (
            <InputGroup
                value={value}
                onChange={onChange}
                placeholder={placeholder}
            />
        );
        
        // ====================================================================
        // TRAINEE FORM COMPONENTS
        // ====================================================================
        
        const determineStatus = (trainee) => {
            if (trainee.status === 'disqualified') return 'DISQUALIFIED';
            if (trainee.knowledgeScore >= 7) return 'PASSED';
            if (trainee.knowledgeScore < 7) return 'FAILED';
            return 'PENDING';
        };
        
        const TraineeForm = ({ trainee, index, updateTrainee, removeTrainee }) => {
            
            const handleInputChange = (field, value) => {
                updateTrainee(index, { ...trainee, [field]: value });
            };

            const handleDisqualify = () => {
                if (trainee.status === 'disqualified') {
                    // Undisqualify
                    updateTrainee(index, { 
                        ...trainee, 
                        status: 'pending', 
                        disqualificationReason: '', 
                        disqualificationProof: '' 
                    });
                } else {
                    // Disqualify: Open a prompt/modal or just set the status
                    const reason = prompt("Enter Disqualification Reason:");
                    if (reason === null) return;
                    const proof = prompt("Enter Proof Link (Image/Video URL):");
                    
                    updateTrainee(index, { 
                        ...trainee, 
                        status: 'disqualified', 
                        knowledgeScore: 0,
                        disqualificationReason: reason || 'No reason provided',
                        disqualificationProof: proof || 'No link provided'
                    });
                }
            };
            
            const cardBg = useMemo(() => {
                if (trainee.status === 'disqualified') return 'bg-hrp-red/20 border-hrp-red/50';
                const status = determineStatus(trainee);
                if (status === 'PASSED') return 'bg-hrp-green/20 border-hrp-green/50';
                if (status === 'FAILED') return 'bg-yellow-500/20 border-yellow-500/50';
                return 'bg-slate-800 border-slate-700';
            }, [trainee]);
            
            const cardTitle = useMemo(() => {
                if (trainee.status === 'disqualified') return 'ðŸš¨ DISQUALIFIED';
                return determineStatus(trainee);
            }, [trainee]);

            return (
                <div className={`p-4 border rounded-lg shadow-md transition-colors ${cardBg}`}>
                    <div className="flex justify-between items-start mb-3">
                        <h4 className="text-lg font-bold text-gray-100">{trainee.traineeName || `Trainee ${index + 1}`} - {cardTitle}</h4>
                        <button
                            onClick={() => removeTrainee(index)}
                            className="text-gray-400 hover:text-hrp-red transition-colors"
                            aria-label="Remove Trainee"
                        >
                            <Trash2 size={20} />
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <InputGroup
                            label="Trainee Name"
                            value={trainee.traineeName}
                            onChange={(v) => handleInputChange('traineeName', v)}
                            placeholder="Name"
                            required
                        />
                         <InputGroup
                            label="Roblox Username"
                            value={trainee.traineeRobloxUsername}
                            onChange={(v) => handleInputChange('traineeRobloxUsername', v)}
                            placeholder="Roblox Username"
                            required
                        />
                        <InputGroup
                            label="Discord ID"
                            value={trainee.traineeDiscordId}
                            onChange={(v) => handleInputChange('traineeDiscordId', v)}
                            placeholder="Discord ID (e.g., 123456789)"
                            required
                        />
                    </div>
                    
                    <hr className="my-4 border-slate-700" />
                    
                    {trainee.status !== 'disqualified' ? (
                        <>
                            <h5 className="text-md font-semibold text-gray-200 mb-3">Assessment</h5>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <InputGroup
                                    label="Knowledge Score (Max 10)"
                                    type="number"
                                    value={trainee.knowledgeScore}
                                    onChange={(v) => handleInputChange('knowledgeScore', Math.min(10, Math.max(0, parseInt(v) || 0)))}
                                    min="0"
                                    max="10"
                                    required
                                />
                                <InputGroup
                                    label="Weapon Deaths"
                                    type="number"
                                    value={trainee.weaponDeaths}
                                    onChange={(v) => handleInputChange('weaponDeaths', parseInt(v) || 0)}
                                    min="0"
                                    required
                                />
                                <div className="flex flex-col justify-end space-y-2">
                                    <CheckboxGroup
                                        label="Killed Sniper Correctly?"
                                        checked={trainee.weaponKilledSniper}
                                        onChange={(v) => handleInputChange('weaponKilledSniper', v)}
                                    />
                                </div>
                            </div>
                            
                            <hr className="my-4 border-slate-700" />
                            
                            <h5 className="text-md font-semibold text-gray-200 mb-3">Moderation</h5>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <CheckboxGroup
                                    label="Good English?"
                                    checked={trainee.modGoodEnglish}
                                    onChange={(v) => handleInputChange('modGoodEnglish', v)}
                                />
                                <CheckboxGroup
                                    label="Asked for Proof?"
                                    checked={trainee.modAskedForProof}
                                    onChange={(v) => handleInputChange('modAskedForProof', v)}
                                />
                                <CheckboxGroup
                                    label="Healed Trainer?"
                                    checked={trainee.modHealedTrainer}
                                    onChange={(v) => handleInputChange('modHealedTrainer', v)}
                                />
                                <CheckboxGroup
                                    label="Punished Correctly?"
                                    checked={trainee.modPunishedCorrectly}
                                    onChange={(v) => handleInputChange('modPunishedCorrectly', v)}
                                />
                            </div>
                            
                            <InputGroup
                                label="Assessment Notes"
                                value={trainee.knowledgeNotes}
                                onChange={(v) => handleInputChange('knowledgeNotes', v)}
                                placeholder="Key points about knowledge"
                            />
                            
                            <div className="mt-4">
                                <button
                                    onClick={handleDisqualify}
                                    className="w-full px-4 py-2 text-sm font-medium text-white bg-hrp-red/80 hover:bg-hrp-red rounded-md transition duration-150 flex items-center justify-center"
                                >
                                    <AlertTriangle size={16} className="mr-2" />
                                    Disqualify Trainee
                                </button>
                            </div>
                        </>
                    ) : (
                        // Disqualified View
                        <div className="space-y-3 p-3 bg-hrp-red/30 rounded-lg">
                            <p className="text-sm font-medium text-gray-200">Reason: {trainee.disqualificationReason}</p>
                            <p className="text-sm font-medium text-gray-200">Proof: <a href={trainee.disqualificationProof} target="_blank" className="text-blue-300 hover:text-blue-400 break-all">{trainee.disqualificationProof}</a></p>
                            <button
                                onClick={handleDisqualify}
                                className="px-4 py-1 text-xs font-medium text-hrp-red bg-white/10 hover:bg-white/20 rounded-md transition duration-150"
                            >
                                Undo Disqualification
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // ====================================================================
        // EVALUATION FORM COMPONENT (MAIN LOGIC)
        // ====================================================================

        const EvaluationForm = ({ db, userId }) => {
            const [trainerRobloxUsername, setTrainerRobloxUsername] = useState('');
            const [coTrainers, setCoTrainers] = useState([{ username: '' }]);
            const [trainees, setTrainees] = useState([]);
            const [copyStatus, setCopyStatus] = useState(null); // null, 'success', 'error', 'loading'
            const [error, setError] = useState(null);

            // Placeholder for the bot's API endpoint
            // !!! YOU MUST REPLACE THIS WITH YOUR BOT'S ACTUAL PUBLIC IP/DOMAIN !!!
            const API_ENDPOINT = "http://YOUR_SERVER_IP_OR_DOMAIN:5000"; 
            // ------------------------------------------------------------------

            const addCoTrainer = () => {
                setCoTrainers([...coTrainers, { username: '' }]);
            };

            const updateCoTrainer = (index, newUsername) => {
                const newCoTrainers = coTrainers.map((ct, i) =>
                    i === index ? { ...ct, username: newUsername } : ct
                );
                setCoTrainers(newCoTrainers);
            };

            const removeCoTrainer = (index) => {
                setCoTrainers(coTrainers.filter((_, i) => i !== index));
            };

            const addTrainee = () => {
                setTrainees([...trainees, {
                    traineeName: '',
                    traineeRobloxUsername: '',
                    traineeDiscordId: '',
                    knowledgeScore: 0,
                    knowledgeNotes: '',
                    weaponDeaths: 0,
                    weaponKilledSniper: false,
                    modGoodEnglish: false,
                    modAskedForProof: false,
                    modHealedTrainer: false,
                    modPunishedCorrectly: false,
                    modNotes: '',
                    status: 'pending', // 'pending', 'disqualified'
                    disqualificationReason: '',
                    disqualificationProof: ''
                }]);
            };

            const updateTrainee = (index, newTraineeData) => {
                const newTrainees = trainees.map((t, i) =>
                    i === index ? newTraineeData : t
                );
                setTrainees(newTrainees);
            };
            
            const removeTrainee = (index) => {
                setTrainees(trainees.filter((_, i) => i !== index));
            };
            
            const generateCopyFormat = () => {
                // Generates the legacy text format for manual Discord copy/paste fallback
                const header = `__**Training Session Results: ${trainerRobloxUsername}**__\nCo-Trainer(s): ${coTrainers.map(ct => ct.username).filter(Boolean).join(', ') || 'N/A'}\n\n`;
                
                const results = trainees.map(t => {
                    const status = determineStatus(t);
                    const discordMention = t.traineeDiscordId ? `<@${t.traineeDiscordId}>` : t.traineeName;
                    const knowledge = t.status === 'disqualified' ? 'DISQUALIFIED' : `${t.knowledgeScore}/10`;
                    
                    let details = `**Status:** ${status}\n`;
                    
                    if (t.status === 'disqualified') {
                        details += `**Reason:** ${t.disqualificationReason}\n**Proof:** <${t.disqualificationProof}>\n`;
                    } else {
                        const modChecks = [
                            t.modGoodEnglish && "Good English",
                            t.modAskedForProof && "Asked for Proof",
                            t.modHealedTrainer && "Healed Trainer",
                            t.modPunishedCorrectly && "Punished Correctly",
                        ].filter(Boolean).join(', ') || 'None';
                        
                        details += `**Knowledge:** ${knowledge}\n` +
                                   `**Weapon:** ${t.weaponDeaths} deaths, ${t.weaponKilledSniper ? 'Sniper Kill' : 'No Sniper Kill'}\n` +
                                   `**Moderation:** ${modChecks}\n` +
                                   `**Notes:** ${t.knowledgeNotes || 'N/A'}`;
                    }
                    
                    return `**${discordMention} (${t.traineeRobloxUsername})**\n${details}\n`;
                }).join('â€”\n');

                const footer = `\n||<@&1381367977252749443>|| (Dashboard Access Role Mention)`;

                return header + results + footer;
            };

            const generateSubmissionData = () => {
                // Creates the structured JSON payload for the bot API
                return {
                    trainerRobloxUsername: trainerRobloxUsername.trim(),
                    coTrainers: coTrainers.map(ct => ct.username.trim()).filter(Boolean),
                    timestamp: new Date().toISOString(),
                    trainees: trainees.map(t => {
                        const status = determineStatus(t);
                        const isDisqualified = t.status === 'disqualified';

                        return {
                            traineeDiscordId: t.traineeDiscordId.trim(),
                            traineeRobloxUsername: t.traineeRobloxUsername.trim(),
                            traineeName: t.traineeName.trim(),
                            status: status,
                            knowledgeScore: isDisqualified ? 0 : Number(t.knowledgeScore),
                            
                            assessment: isDisqualified ? null : {
                                knowledgeNotes: t.knowledgeNotes.trim(),
                                moderation: {
                                    goodEnglish: t.modGoodEnglish,
                                    askedForProof: t.modAskedForProof,
                                    healedTrainer: t.modHealedTrainer,
                                    punishedCorrectly: t.modPunishedCorrectly,
                                    notes: t.modNotes.trim(),
                                },
                                weaponHandling: {
                                    deaths: t.weaponDeaths,
                                    killedSniper: t.weaponKilledSniper,
                                },
                            },
                            disqualification: isDisqualified ? { 
                                proofLink: t.disqualificationProof || 'N/A',
                                reason: t.disqualificationReason || 'N/A' 
                            } : null
                        };
                    }).filter(t => t.traineeDiscordId) // Only submit trainees with IDs
                };
            };
            
            // ====================================================================
            // NEW API SUBMISSION LOGIC
            // ====================================================================
            const handleCopyResults = async () => {
                setCopyStatus('loading');
                setError(null);
                
                const submissionData = generateSubmissionData();
                
                // Fallback: Copy the standard format for manual pasting
                const fallbackText = generateCopyFormat(); 
                navigator.clipboard.writeText(fallbackText);
                
                // Check for minimum data before submission
                if (!trainerRobloxUsername || trainees.length === 0 || trainees.some(t => !t.traineeDiscordId || !t.traineeRobloxUsername)) {
                    setCopyStatus('error');
                    setError('Missing Trainer Username or Trainee Discord/Roblox IDs.');
                    setTimeout(() => setCopyStatus(null), 3000);
                    setTimeout(() => setError(null), 5000);
                    return;
                }

                // POST to the Flask Endpoint
                try {
                    const response = await fetch(`${API_ENDPOINT}/submit-evaluation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(submissionData),
                    });

                    if (response.ok) {
                        setCopyStatus('success');
                    } else {
                        console.error('API Post Failed:', response.status);
                        const errorData = await response.json().catch(() => ({ error: 'No details from server.' }));
                        console.error('Server Error Details:', errorData);
                        setCopyStatus('error');
                        setError(`Submission failed (HTTP ${response.status}). Bot error: ${errorData.error || 'Check console.'}`);
                    }
                } catch (err) {
                    console.error('Network Error:', err);
                    setCopyStatus('error');
                    setError('Could not connect to the bot server. Check the API_ENDPOINT URL and port 5000.');
                } finally {
                    setTimeout(() => setCopyStatus(null), 3000);
                    setTimeout(() => setError(null), 5000);
                }
            };
            // ====================================================================


            return (
                <div className="space-y-6">
                    <h3 className="text-xl font-bold text-gray-100 border-b border-slate-700 pb-2">Training Evaluation</h3>

                    {/* Trainer & Co-Trainer Section */}
                    <div className="p-4 bg-slate-800 rounded-lg shadow-inner">
                        <h4 className="text-lg font-semibold text-gray-200 mb-3">Trainer Information</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <InputGroup
                                label="Your Roblox Username"
                                value={trainerRobloxUsername}
                                onChange={setTrainerRobloxUsername}
                                placeholder="Roblox Username"
                                required
                            />
                        </div>
                        
                        <h5 className="text-md font-medium text-gray-300 mt-4 mb-2">Co-Trainers (Optional)</h5>
                        <div className="space-y-2">
                            {coTrainers.map((ct, index) => (
                                <div key={index} className="flex space-x-2 items-center">
                                    <div className="flex-grow">
                                        <RoleInput
                                            value={ct.username}
                                            onChange={(v) => updateCoTrainer(index, v)}
                                            placeholder={`Co-Trainer #${index + 1} Roblox Username`}
                                        />
                                    </div>
                                    {coTrainers.length > 1 && (
                                        <button
                                            onClick={() => removeCoTrainer(index)}
                                            className="p-2 text-gray-400 hover:text-hrp-red rounded-full hover:bg-slate-700 transition-colors"
                                        >
                                            <X size={16} />
                                        </button>
                                    )}
                                </div>
                            ))}
                            <button
                                onClick={addCoTrainer}
                                className="px-3 py-1 text-sm text-hrp-green border border-hrp-green rounded-md hover:bg-hrp-green/10 transition-colors flex items-center"
                            >
                                <Plus size={16} className="mr-1" /> Add Co-Trainer
                            </button>
                        </div>
                    </div>

                    {/* Trainee Section */}
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h4 className="text-xl font-bold text-gray-100">Trainees ({trainees.length})</h4>
                            <button
                                onClick={addTrainee}
                                className="px-4 py-2 text-sm text-white bg-hrp-green/80 hover:bg-hrp-green rounded-md transition-colors flex items-center"
                            >
                                <Plus size={18} className="mr-2" /> Add Trainee
                            </button>
                        </div>
                        
                        {trainees.length === 0 && (
                            <p className="text-gray-400 p-4 border border-dashed border-slate-700 rounded-lg text-center">Click 'Add Trainee' to begin evaluation.</p>
                        )}
                        
                        <div className="space-y-6 custom-scroll max-h-[60vh] p-1">
                            {trainees.map((trainee, index) => (
                                <TraineeForm
                                    key={index}
                                    trainee={trainee}
                                    index={index}
                                    updateTrainee={updateTrainee}
                                    removeTrainee={removeTrainee}
                                />
                            ))}
                        </div>
                    </div>

                    {/* Submission/Copy Button */}
                    <div className="pt-4 border-t border-slate-700">
                        {error && (
                            <div className="p-3 mb-4 text-sm text-hrp-red bg-hrp-red/20 rounded-lg flex items-center">
                                <AlertTriangle size={18} className="mr-2" />
                                {error}
                            </div>
                        )}
                        <button
                            onClick={handleCopyResults}
                            disabled={copyStatus === 'loading'}
                            className={`w-full px-4 py-3 text-lg font-bold text-white rounded-lg transition-colors duration-200 flex items-center justify-center ${
                                copyStatus === 'success' ? 'bg-hrp-green/90' :
                                copyStatus === 'error' ? 'bg-hrp-red/90' :
                                copyStatus === 'loading' ? 'bg-slate-700 cursor-not-allowed' :
                                'bg-blue-600 hover:bg-blue-700'
                            }`}
                        >
                            {copyStatus === 'loading' ? (
                                <><Loader2 size={20} className="mr-3 animate-spin" /> Submitting to Bot API...</>
                            ) : copyStatus === 'success' ? (
                                <><ClipboardCheck size={20} className="mr-3" /> Submitted to Bot API (and Copied for Fallback)</>
                            ) : copyStatus === 'error' ? (
                                <><AlertTriangle size={20} className="mr-3" /> Submission Failed (Copied for Manual Paste)</>
                            ) : (
                                <><List size={20} className="mr-3" /> Submit Evaluation & Post to Discord</>
                            )}
                        </button>
                    </div>
                </div>
            );
        };
        
        // ====================================================================
        // VOICE VERIFICATION COMPONENT
        // ====================================================================

        const VoiceVerificationTab = ({ db, userId }) => {
            const [trainees, setTrainees] = useState([{ traineeName: '', traineeRobloxUsername: '', traineeDiscordId: '', ageRange: '' }]);
            const [copyStatus, setCopyStatus] = useState(null); // null, 'success', 'error', 'loading'
            const [error, setError] = useState(null);

            // Placeholder for the bot's API endpoint
            // !!! YOU MUST REPLACE THIS WITH YOUR BOT'S ACTUAL PUBLIC IP/DOMAIN !!!
            const API_ENDPOINT = "http://YOUR_SERVER_IP_OR_DOMAIN:5000"; 
            // ------------------------------------------------------------------

            const addTrainee = () => {
                setTrainees([...trainees, { traineeName: '', traineeRobloxUsername: '', traineeDiscordId: '', ageRange: '' }]);
            };

            const updateTrainee = (index, field, value) => {
                const newTrainees = trainees.map((t, i) =>
                    i === index ? { ...t, [field]: value } : t
                );
                setTrainees(newTrainees);
            };

            const removeTrainee = (index) => {
                setTrainees(trainees.filter((_, i) => i !== index));
            };

            const generateCopyFormat = () => {
                // Generates the legacy text format for manual Discord copy/paste fallback
                const header = `__**Voice Verification Results**__\nDate: ${new Date().toLocaleDateString('en-GB')}\n\n`;
                
                const results = trainees.map(t => {
                    const discordMention = t.traineeDiscordId ? `<@${t.traineeDiscordId}>` : t.traineeName;
                    
                    return `**${discordMention} (${t.traineeRobloxUsername})**\n` +
                           `**Status:** âœ… Verified\n` +
                           `**Age Range:** ${t.ageRange || 'N/A'}\n`;
                }).join('â€”\n');

                const footer = `\n||<@&1381367977252749443>|| (Dashboard Access Role Mention)`;

                return header + results + footer;
            };

            const generateSubmissionData = () => {
                // Creates the structured JSON payload for the bot API
                return {
                    date: new Date().toLocaleDateString('en-GB'),
                    trainees: trainees.map(t => ({
                        traineeDiscordId: t.traineeDiscordId.trim(),
                        traineeRobloxUsername: t.traineeRobloxUsername.trim(),
                        ageRange: t.ageRange,
                    })).filter(t => t.traineeDiscordId)
                };
            };

            // ====================================================================
            // NEW API SUBMISSION LOGIC
            // ====================================================================
            const handleCopyResults = async () => {
                setCopyStatus('loading');
                setError(null);

                const submissionData = generateSubmissionData();
                
                // Fallback: Copy the standard format for manual pasting
                const fallbackText = generateCopyFormat(); 
                navigator.clipboard.writeText(fallbackText);

                // Check for minimum data before submission
                if (trainees.length === 0 || trainees.some(t => !t.traineeDiscordId || !t.traineeRobloxUsername || !t.ageRange)) {
                    setCopyStatus('error');
                    setError('All Trainees must have a Discord ID, Roblox Username, and Age Range selected.');
                    setTimeout(() => setCopyStatus(null), 3000);
                    setTimeout(() => setError(null), 5000);
                    return;
                }

                // POST to the Flask Endpoint
                try {
                    const response = await fetch(`${API_ENDPOINT}/submit-voice-verification`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(submissionData),
                    });

                    if (response.ok) {
                        setCopyStatus('success');
                    } else {
                        console.error('API Post Failed:', response.status);
                        const errorData = await response.json().catch(() => ({ error: 'No details from server.' }));
                        console.error('Server Error Details:', errorData);
                        setCopyStatus('error');
                        setError(`Submission failed (HTTP ${response.status}). Bot error: ${errorData.error || 'Check console.'}`);
                    }
                } catch (err) {
                    console.error('Network Error:', err);
                    setCopyStatus('error');
                    setError('Could not connect to the bot server. Check the API_ENDPOINT URL and port 5000.');
                } finally {
                    setTimeout(() => setCopyStatus(null), 3000);
                    setTimeout(() => setError(null), 5000);
                }
            };
            // ====================================================================

            return (
                <div className="space-y-6">
                    <h3 className="text-xl font-bold text-gray-100 border-b border-slate-700 pb-2">Voice Verification</h3>

                    {/* Trainee Section */}
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h4 className="text-xl font-bold text-gray-100">Verified Trainees ({trainees.length})</h4>
                            <button
                                onClick={addTrainee}
                                className="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors flex items-center"
                            >
                                <Plus size={18} className="mr-2" /> Add Verified Trainee
                            </button>
                        </div>
                        
                        {trainees.length === 0 && (
                            <p className="text-gray-400 p-4 border border-dashed border-slate-700 rounded-lg text-center">Add verified trainees to record the results.</p>
                        )}
                        
                        <div className="space-y-6 custom-scroll max-h-[60vh] p-1">
                            {trainees.map((trainee, index) => (
                                <div key={index} className="p-4 bg-slate-800 border border-slate-700 rounded-lg shadow-md">
                                    <div className="flex justify-between items-start mb-3">
                                        <h4 className="text-lg font-bold text-gray-100">Trainee #{index + 1}</h4>
                                        <button
                                            onClick={() => removeTrainee(index)}
                                            className="text-gray-400 hover:text-hrp-red transition-colors"
                                            aria-label="Remove Trainee"
                                        >
                                            <Trash2 size={20} />
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <InputGroup
                                            label="Roblox Username"
                                            value={trainee.traineeRobloxUsername}
                                            onChange={(v) => updateTrainee(index, 'traineeRobloxUsername', v)}
                                            placeholder="Roblox Username"
                                            required
                                        />
                                        <InputGroup
                                            label="Discord ID"
                                            value={trainee.traineeDiscordId}
                                            onChange={(v) => updateTrainee(index, 'traineeDiscordId', v)}
                                            placeholder="Discord ID"
                                            required
                                        />
                                        <div className="flex flex-col space-y-1">
                                            <label className="text-sm font-medium text-gray-300">Age Range<span className="text-hrp-red">*</span></label>
                                            <select
                                                value={trainee.ageRange}
                                                onChange={(e) => updateTrainee(index, 'ageRange', e.target.value)}
                                                required
                                                className="w-full px-3 py-2 text-sm text-white bg-slate-800 border border-slate-700 rounded-md focus:ring-hrp-green focus:border-hrp-green transition duration-150"
                                            >
                                                <option value="" disabled>Select Age</option>
                                                <option value="Under 18">Under 18</option>
                                                <option value="18+">18+</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Submission/Copy Button */}
                    <div className="pt-4 border-t border-slate-700">
                        {error && (
                            <div className="p-3 mb-4 text-sm text-hrp-red bg-hrp-red/20 rounded-lg flex items-center">
                                <AlertTriangle size={18} className="mr-2" />
                                {error}
                            </div>
                        )}
                        <button
                            onClick={handleCopyResults}
                            disabled={copyStatus === 'loading'}
                            className={`w-full px-4 py-3 text-lg font-bold text-white rounded-lg transition-colors duration-200 flex items-center justify-center ${
                                copyStatus === 'success' ? 'bg-hrp-green/90' :
                                copyStatus === 'error' ? 'bg-hrp-red/90' :
                                copyStatus === 'loading' ? 'bg-slate-700 cursor-not-allowed' :
                                'bg-blue-600 hover:bg-blue-700'
                            }`}
                        >
                            {copyStatus === 'loading' ? (
                                <><Loader2 size={20} className="mr-3 animate-spin" /> Submitting to Bot API...</>
                            ) : copyStatus === 'success' ? (
                                <><ClipboardCheck size={20} className="mr-3" /> Submitted to Bot API (and Copied for Fallback)</>
                            ) : copyStatus === 'error' ? (
                                <><AlertTriangle size={20} className="mr-3" /> Submission Failed (Copied for Manual Paste)</>
                            ) : (
                                <><Mic size={20} className="mr-3" /> Submit Verification & Post to Discord</>
                            )}
                        </button>
                    </div>
                </div>
            );
        };
        
        // ====================================================================
        // ANNOUNCEMENT TAB (Placeholder)
        // ====================================================================
        
        // This is left as a simple placeholder as no specific functionality was requested, 
        // but it is included for the structure.
        const AnnounceTrainingTab = ({ db, userId }) => {
             const [announcementText, setAnnouncementText] = useState('');
             
             const handleAnnounce = () => {
                 alert('Announce functionality would be implemented here, potentially posting to the bot\'s API too.');
                 console.log("Announcement Text:", announcementText);
             };
             
             return (
                <div className="space-y-6 p-4 bg-slate-800 rounded-lg">
                    <h3 className="text-xl font-bold text-gray-100 border-b border-slate-700 pb-2">Training Announcement</h3>
                    <InputGroup
                        label="Announcement Details"
                        value={announcementText}
                        onChange={setAnnouncementText}
                        placeholder="e.g., Training starting in 5 minutes! Join VC 1."
                    />
                    <button
                        onClick={handleAnnounce}
                        className="w-full px-4 py-3 text-lg font-bold text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors duration-200 flex items-center justify-center"
                    >
                        <Volume2 size={20} className="mr-3" /> Announce
                    </button>
                </div>
             );
        };


        // ====================================================================
        // APP STRUCTURE
        // ====================================================================
        
        const TabButton = ({ icon: Icon, label, isActive, onClick }) => (
            <button
                onClick={onClick}
                className={`flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 ${
                    isActive
                        ? 'bg-slate-700 text-hrp-green border-b-2 border-hrp-green'
                        : 'bg-slate-800 text-gray-400 hover:bg-slate-700/50 hover:text-gray-300 border-b-2 border-transparent'
                }`}
            >
                <Icon size={18} />
                <span>{label}</span>
            </button>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('results');
            
            // Dummy props for the sake of the demo, replace with real logic if needed
            const db = {}; 
            const userId = 'user123';

            return (
                <div className="min-h-screen p-4 sm:p-8 flex justify-center items-start">
                    <div className="w-full max-w-4xl bg-slate-800 rounded-xl shadow-2xl p-6 border border-slate-700">
                        <header className="mb-6 pb-4 border-b border-slate-700">
                            <h1 className="text-3xl font-extrabold text-white">HR Trainee Console</h1>
                            <p className="text-gray-400">Automated Training & Verification System</p>
                        </header>

                        <div className="flex space-x-2 mb-6 border-b border-slate-700/50">
                            <TabButton
                                icon={Volume2}
                                label="Announcement"
                                isActive={activeTab === 'announcement'}
                                onClick={() => setActiveTab('announcement')}
                            />
                            <TabButton
                                icon={List}
                                label="Submit Results"
                                isActive={activeTab === 'results'}
                                onClick={() => setActiveTab('results')}
                            />
                            <TabButton
                                icon={Mic}
                                label="Voice Verification"
                                isActive={activeTab === 'voice'}
                                onClick={() => setActiveTab('voice')}
                            />
                        </div>

                        {/* Conditional Content Rendering */}
                        {activeTab === 'results' && (
                            <EvaluationForm db={db} userId={userId} />
                        )}

                        {activeTab === 'announcement' && (
                            <AnnounceTrainingTab db={db} userId={userId} />
                        )}

                        {activeTab === 'voice' && (
                            <VoiceVerificationTab db={db} userId={userId} />
                        )}
                    </div>
                </div>
            );
        };

        // Render the App component to the root element
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    </script>

</body>
</html>
